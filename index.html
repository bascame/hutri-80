<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualisasi Anggaran HUT RI ke-80 Kp.cemplang Rt 002/002</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f7f4; /* Light, warm background */
        }
        .chart-container {
            position: relative;
            height: 320px;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .table-responsive-wrapper {
            overflow-x: auto; /* Enable horizontal scrolling for tables */
            -webkit-overflow-scrolling: touch;
            border-radius: 0.75rem; /* Rounded corners for the scrollable area */
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); /* Subtle shadow */
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        /* Hidden by default */
        .hidden {
            display: none;
        }
        /* Simple Modal Styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .modal-buttons button {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-buttons .confirm-btn {
            background-color: #b91c1c;
            color: white;
        }
        .modal-buttons .confirm-btn:hover {
            background-color: #991b1b;
        }
        .modal-buttons .cancel-btn {
            background-color: #e5e7eb;
            color: #374151;
        }
        .modal-buttons .cancel-btn:hover {
            background-color: #d1d5db;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 lg:p-10">

        <header class="text-center mb-8 md:mb-10">
            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-900">Anggaran HUT RI ke-80</h1>
            <p class="mt-2 text-base sm:text-lg text-gray-600">Kp.cemplang Rt 002/002 Desa.Sukamaju Kec.Cibungbulang Kab. Bogor</p>
            <!-- Navigation Menu -->
            <nav class="mt-6">
                <ul class="flex flex-wrap justify-center space-x-4 sm:space-x-6">
                    <li><a href="#" id="navDashboard" class="px-3 py-2 rounded-lg text-red-700 font-semibold hover:bg-red-100 hover:text-red-900 transition-colors duration-200">Dashboard</a></li>
                    <li><a href="#" id="navManageBudget" class="px-3 py-2 rounded-lg text-red-700 font-semibold hover:bg-red-100 hover:text-red-900 transition-colors duration-200">Manajemen Anggaran</a></li>
                    <li><a href="#" id="navUserDetails" class="px-3 py-2 rounded-lg text-red-700 font-semibold hover:bg-red-100 hover:text-red-900 transition-colors duration-200">Rincian Anggaran</a></li>
                    <li id="adminMenuLink" class="hidden"><a href="#" id="navAdminPanel" class="px-3 py-2 rounded-lg text-red-700 font-semibold hover:bg-red-100 hover:text-red-900 transition-colors duration-200">Admin Panel</a></li>
                    <li><a href="#" id="logoutButton" class="px-3 py-2 rounded-lg text-gray-600 font-semibold hover:bg-gray-100 hover:text-gray-800 transition-colors duration-200">Logout</a></li>
                </ul>
            </nav>
        </header>

        <main>
            <!-- Login/Auth Section - Initially visible -->
            <section id="authSection" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200 mb-8 max-w-md mx-auto">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-6 text-center">Login</h2>
                <form id="loginForm">
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="username" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="password" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <button type="submit" class="w-full px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors shadow-md">Login</button>
                    <p id="loginMessage" class="text-center mt-4 text-sm text-red-500"></p>
                </form>
            </section>

            <!-- Main Dashboard Content - Initially hidden -->
            <div id="appContent" class="hidden">
                <section id="kpi" class="mb-8 lg:mb-10">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4">Ringkasan Umum</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 flex flex-col justify-center items-center text-center">
                            <h3 class="text-lg font-semibold text-gray-500">Total Anggaran</h3>
                            <p id="totalAnggaran" class="text-3xl sm:text-4xl font-bold text-red-700 mt-2">Rp 0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 flex flex-col justify-center items-center text-center">
                            <h3 class="text-lg font-semibold text-gray-500">Dana dari Masyarakat</h3>
                            <p id="danaMasyarakat" class="text-3xl sm:text-4xl font-bold text-blue-700 mt-2">Rp 0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 flex flex-col justify-center items-center text-center">
                            <h3 class="text-lg font-semibold text-gray-500">Dana dari Donatur</h3>
                            <p id="danaDonatur" class="text-3xl sm:text-4xl font-bold text-green-700 mt-2">Rp 0</p>
                        </div>
                    </div>
                </section>

                <section id="visualizations" class="mb-8 lg:mb-10">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4">Visualisasi Data</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-lg sm:text-xl font-semibold text-center mb-4">Alokasi Anggaran per Kategori</h3>
                            <div class="chart-container">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-lg sm:text-xl font-semibold text-center mb-4">Komposisi Sumber Dana</h3>
                            <div class="chart-container">
                                <canvas id="sourceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="manage-budget" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8 lg:mb-10 hidden">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4">Manajemen Anggaran</h2>
                    <p class="mb-6 text-gray-600 text-sm sm:text-base">Gunakan formulir di bawah ini untuk menambah item anggaran baru atau memperbarui item yang sudah ada.</p>
                    <form id="budgetForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="formKategori" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                            <input type="text" id="formKategori" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="formItem" class="block text-sm font-medium text-gray-700 mb-1">Item</label>
                            <input type="text" id="formItem" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="formVolume" class="block text-sm font-medium text-gray-700 mb-1">Volume/Jumlah</label>
                            <input type="number" id="formVolume" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="formSatuan" class="block text-sm font-medium text-gray-700 mb-1">Satuan</label>
                            <input type="text" id="formSatuan" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="formHarga" class="block text-sm font-medium text-gray-700 mb-1">Harga Satuan (Rp)</label>
                            <input type="number" id="formHarga" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="formSumber" class="block text-sm font-medium text-gray-700 mb-1">Sumber Dana</label>
                            <select id="formSumber" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                                <option value="">Pilih Sumber</option>
                                <option value="Masyarakat">Masyarakat</option>
                                <option value="Donatur Musiman">Donatur Musiman</option>
                                <option value="Masyarakat/Donatur">Masyarakat/Donatur</option>
                            </select>
                        </div>
                        <div>
                            <label for="formPenanggungJawab" class="block text-sm font-medium text-gray-700 mb-1">Penanggung Jawab</label>
                            <input type="text" id="formPenanggungJawab" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div class="col-span-full flex flex-col sm:flex-row gap-4 mt-4">
                            <button type="submit" id="addItemBtn" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors shadow-md">Tambah Item</button>
                            <button type="button" id="updateItemBtn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-md hidden">Perbarui Item</button>
                            <button type="button" id="cancelEditBtn" class="px-6 py-2 bg-gray-400 text-gray-800 font-semibold rounded-lg hover:bg-gray-500 transition-colors shadow-md hidden">Batal Edit</button>
                        </div>
                    </form>
                </section>

                <section id="details" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hidden">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4">Rincian Detail Anggaran</h2>
                    <p class="mb-6 text-gray-600 text-sm sm:text-base">Gunakan filter di bawah untuk menjelajahi setiap item dalam anggaran. Anda dapat menyaring berdasarkan kategori pengeluaran atau sumber pendanaan, serta mencari item spesifik untuk analisis yang lebih mendalam.</p>
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <div class="flex-1">
                            <label for="categoryFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter Kategori</label>
                            <select id="categoryFilter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                <option value="all">Semua Kategori</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="sourceFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter Sumber Dana</label>
                            <select id="sourceFilter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                <option value="all">Semua Sumber</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="searchBox" class="block text-sm font-medium text-gray-700 mb-1">Cari Item</label>
                            <input type="text" id="searchBox" placeholder="Contoh: Sewa Panggung" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        </div>
                    </div>

                    <div class="table-responsive-wrapper">
                        <table class="min-w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="p-3 font-semibold text-xs sm:text-sm text-gray-700 border-b">Item</th>
                                    <th class="p-3 font-semibold text-xs sm:text-sm text-gray-700 border-b">Kategori</th>
                                    <th class="p-3 font-semibold text-xs sm:text-sm text-gray-700 border-b text-right">Total Biaya</th>
                                    <th class="p-3 font-semibold text-xs sm:text-sm text-gray-700 border-b">Sumber Dana</th>
                                    <th class="p-3 font-semibold text-xs sm:text-sm text-gray-700 border-b">Penanggung Jawab</th>
                                    <th class="p-3 font-semibold text-xs sm:text-sm text-gray-700 border-b text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="budgetTable">
                            </tbody>
                        </table>
                    </div>
                    <p id="tableSummary" class="text-sm text-gray-500 mt-4"></p>
                </section>

                <section id="adminPanel" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8 lg:mb-10 hidden">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4">Panel Admin: Manajemen Pengguna</h2>
                    <p class="mb-6 text-gray-600 text-sm sm:text-base">Tambahkan atau kelola pengguna yang dapat mengakses sistem anggaran.</p>

                    <form id="addUserForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="newUsername" class="block text-sm font-medium text-gray-700 mb-1">Username Baru</label>
                            <input type="text" id="newUsername" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">Password Baru</label>
                            <input type="password" id="newPassword" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="newUserRole" class="block text-sm font-medium text-gray-700 mb-1">Peran Pengguna</label>
                            <select id="newUserRole" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="col-span-full">
                            <button type="submit" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors shadow-md">Tambah Pengguna</button>
                        </div>
                    </form>

                    <h3 class="text-lg sm:text-xl font-semibold text-gray-900 mb-3">Daftar Pengguna</h3>
                    <div class="table-responsive-wrapper">
                        <table class="min-w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="p-3 font-semibold text-xs sm:text-sm text-gray-700 border-b">Username</th>
                                    <th class="p-3 font-semibold text-xs sm:text-sm text-gray-700 border-b">Peran</th>
                                    <th class="p-3 font-semibold text-xs sm:text-sm text-gray-700 border-b text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <!-- User rows will be injected here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <p id="userManagementMessage" class="text-sm text-red-500 mt-4"></p>
                </section>

                <section id="notes" class="mt-8 lg:mt-10">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4">Catatan Penting</h2>
                    <div id="accordionContainer">
                    </div>
                </section>
            </div>
        </main>

        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Dibuat untuk Panitia HUT RI ke-80 | &copy; 2025</p>
        </footer>

    </div>

    <!-- Custom Modal for Alerts/Confirms -->
    <div id="customModal" class="modal hidden">
        <div class="modal-content">
            <p id="modalMessage" class="text-lg text-gray-800"></p>
            <div id="modalButtons" class="modal-buttons">
                <!-- Buttons will be injected here -->
            </div>
        </div>
    </div>

    <script>
        // --- HARDCODED ADMIN CREDENTIALS (FOR DEMONSTRATION ONLY - NOT SECURE) ---
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'agustus2025@';
        // -------------------------------------------------------------------------

        let budgetData = [];
        let users = []; // Client-side store for mock user management
        let currentUser = null; // Stores logged-in user info (e.g., { username: 'admin', role: 'admin' })
        let autoSaveInterval;

        const notesData = [
            { title: "Fleksibilitas Anggaran", content: "Angka-angka di atas adalah estimasi dan bisa disesuaikan dengan skala acara, ketersediaan dana, serta negosiasi dengan vendor." },
            { title: "Proposal Donatur", content: "Untuk mendapatkan donatur musiman,berisi rincian kegiatan, tujuan, serta benefit yang bisa didapatkan donatur " },
            { title: "Transparansi", content: "Penting untuk selalu transparan dalam pengelolaan dana, terutama yang berasal dari masyarakat dan donatur, dengan membuat laporan keuangan sederhana yang bisa diakses." },
            { title: "Negosiasi", content: "Jangan ragu untuk bernegosiasi harga dengan penyedia jasa atau penjual barang untuk mendapatkan penawaran terbaik." }
        ];

        // DOM Elements
        const authSection = document.getElementById('authSection');
        const appContent = document.getElementById('appContent');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginMessage = document.getElementById('loginMessage');
        const logoutButton = document.getElementById('logoutButton');

        // Navigation elements
        const navDashboard = document.getElementById('navDashboard');
        const navManageBudget = document.getElementById('navManageBudget');
        const navUserDetails = document.getElementById('navUserDetails');
        const navAdminPanel = document.getElementById('navAdminPanel');
        const adminMenuLink = document.getElementById('adminMenuLink');

        // Sections
        const kpiSection = document.getElementById('kpi');
        const visualizationsSection = document.getElementById('visualizations');
        const manageBudgetSection = document.getElementById('manage-budget');
        const detailsSection = document.getElementById('details');
        const adminPanelSection = document.getElementById('adminPanel');

        const categoryFilter = document.getElementById('categoryFilter');
        const sourceFilter = document.getElementById('sourceFilter');
        const searchBox = document.getElementById('searchBox');
        const budgetTableBody = document.getElementById('budgetTable');
        const tableSummary = document.getElementById('tableSummary');

        const formKategori = document.getElementById('formKategori');
        const formItem = document.getElementById('formItem');
        const formVolume = document.getElementById('formVolume');
        const formSatuan = document.getElementById('formSatuan');
        const formHarga = document.getElementById('formHarga');
        const formSumber = document.getElementById('formSumber');
        const formPenanggungJawab = document.getElementById('formPenanggungJawab');
        const addItemBtn = document.getElementById('addItemBtn');
        const updateItemBtn = document.getElementById('updateItemBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const budgetForm = document.getElementById('budgetForm');

        // Admin Panel Elements
        const addUserForm = document.getElementById('addUserForm');
        const newUsernameInput = document.getElementById('newUsername');
        const newPasswordInput = document.getElementById('newPassword');
        const newUserRoleSelect = document.getElementById('newUserRole');
        const usersTableBody = document.getElementById('usersTable');
        const userManagementMessage = document.getElementById('userManagementMessage');

        // Custom Modal Elements
        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalButtons = document.getElementById('modalButtons');

        let currentEditId = null; // Changed from currentEditIndex to currentEditId
        let categoryChartInstance;
        let sourceChartInstance;
        
        // --- Custom Modal Functions (replaces alert/confirm) ---
        const showModal = (message, type = 'alert', onConfirm = null) => {
            modalMessage.textContent = message;
            modalButtons.innerHTML = ''; // Clear previous buttons

            if (type === 'alert') {
                const okButton = document.createElement('button');
                okButton.textContent = 'OK';
                okButton.className = 'confirm-btn';
                okButton.onclick = () => customModal.classList.add('hidden');
                modalButtons.appendChild(okButton);
            } else if (type === 'confirm') {
                const confirmButton = document.createElement('button');
                confirmButton.textContent = 'Ya';
                confirmButton.className = 'confirm-btn';
                confirmButton.onclick = () => {
                    customModal.classList.add('hidden');
                    if (onConfirm) onConfirm(true);
                };
                modalButtons.appendChild(confirmButton);

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Tidak';
                cancelButton.className = 'cancel-btn';
                cancelButton.onclick = () => {
                    customModal.classList.add('hidden');
                    if (onConfirm) onConfirm(false);
                };
                modalButtons.appendChild(cancelButton);
            }
            customModal.classList.remove('hidden');
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        };

        // --- Authentication and Authorization Functions ---

        const showSection = (section) => {
            const sections = [kpiSection, visualizationsSection, manageBudgetSection, detailsSection, adminPanelSection];
            sections.forEach(s => s.classList.add('hidden'));
            section.classList.remove('hidden');
        };

        const checkAuth = () => {
            const storedUser = JSON.parse(localStorage.getItem('currentUser'));
            if (storedUser) {
                currentUser = storedUser;
                showAppContent();
                updateNavigationVisibility();
                loadBudgetData(); // Load data from local storage
                loadUsersData(); // Load users from local storage
                startAutoSave();
            } else {
                showAuthSection();
            }
        };

        const showAuthSection = () => {
            authSection.classList.remove('hidden');
            appContent.classList.add('hidden');
        };

        const showAppContent = () => {
            authSection.classList.add('hidden');
            appContent.classList.remove('hidden');
            // Default to dashboard view
            showSection(kpiSection);
            visualizationsSection.classList.remove('hidden'); // Visualizations are part of dashboard
        };

        const login = (username, password) => {
            loginMessage.textContent = 'Logging in...';
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                currentUser = { id: 'admin123', username: ADMIN_USERNAME, role: 'admin' };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                loginMessage.textContent = '';
                showAppContent();
                updateNavigationVisibility();
                loadBudgetData();
                loadUsersData(); // Ensure users data is loaded for admin
                startAutoSave();
            } else {
                loginMessage.textContent = 'Login failed. Invalid credentials.';
                currentUser = null;
            }
        };

        const logout = () => {
            currentUser = null;
            localStorage.removeItem('currentUser');
            clearInterval(autoSaveInterval); // Stop auto-save
            budgetData = []; // Clear data on logout
            users = []; // Clear users on logout (except the default admin if it's the only one)
            updateAllVisualizations(); // Clear UI
            showAuthSection();
            updateNavigationVisibility();
        };

        const updateNavigationVisibility = () => {
            if (currentUser && currentUser.role === 'admin') {
                adminMenuLink.classList.remove('hidden');
            } else {
                adminMenuLink.classList.add('hidden');
            }
        };

        // --- Data Loading and Saving (Local Storage Mock) ---

        const loadBudgetData = () => {
            const storedBudgetData = localStorage.getItem('budgetData');
            if (storedBudgetData) {
                budgetData = JSON.parse(storedBudgetData);
                // Ensure all loaded items have an ID
                budgetData.forEach(item => {
                    if (!item.id) {
                        item.id = 'item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); // Add unique ID if missing
                    }
                });
            } else {
                // Initial dummy data if no data exists, assign IDs
                budgetData = [
                    { id: 'item_1', kategori: 'Sewa', item: 'Sewa Panggung', volume: 1, satuan: 'Unit', harga: 5000000, total: 5000000, sumber: 'Masyarakat', penanggungJawab: 'Bapak RT' },
                    { id: 'item_2', kategori: 'Perlengkapan', item: 'Sound System', volume: 1, satuan: 'Unit', harga: 3000000, total: 3000000, sumber: 'Donatur Musiman', penanggungJawab: 'Panitia' },
                    { id: 'item_3', kategori: 'Konsumsi', item: 'Nasi Kotak', volume: 100, satuan: 'Pcs', harga: 25000, total: 2500000, sumber: 'Masyarakat', penanggungJawab: 'Ibu PKK' },
                    { id: 'item_4', kategori: 'Hadiah', item: 'Hadiah Lomba Anak', volume: 1, satuan: 'Paket', harga: 1500000, total: 1500000, sumber: 'Donatur Musiman', penanggungJawab: 'Panitia' },
                    { id: 'item_5', kategori: 'Dekorasi', item: 'Bendera Merah Putih', volume: 20, satuan: 'Pcs', harga: 15000, total: 300000, sumber: 'Masyarakat', penanggungJawab: 'Karang Taruna' }
                ];
            }
            updateAllVisualizations();
        };

        const saveBudgetData = () => {
            localStorage.setItem('budgetData', JSON.stringify(budgetData));
            console.log('Budget data auto-saved to local storage.');
        };

        const startAutoSave = () => {
            clearInterval(autoSaveInterval); // Clear any existing interval
            autoSaveInterval = setInterval(saveBudgetData, 30000); // Save every 30 seconds
        };

        // --- Budget Calculation & Rendering ---

        const getFullBudgetData = () => {
            const nonContingencyData = budgetData.filter(item => item.item !== 'Biaya Tak Terduga (Kontingensi)');
            const baseTotal = nonContingencyData.reduce((sum, item) => sum + item.total, 0);
            const contingency = Math.round(baseTotal * 0.10);

            const fullData = [...nonContingencyData]; // Creates new array, but objects inside are still references to original budgetData objects
            
            if (baseTotal > 0) {
                fullData.push({ // This is a new object
                    kategori: 'Lain-lain',
                    item: 'Biaya Tak Terduga (Kontingensi)',
                    volume: 1,
                    satuan: 'Paket',
                    harga: contingency,
                    total: contingency,
                    sumber: 'Masyarakat/Donatur',
                    penanggungJawab: 'Panitia'
                });
            }
            
            return fullData;
        };

        const populateFilters = () => {
            const fullData = getFullBudgetData();
            const categories = [...new Set(fullData.map(d => d.kategori))];
            const sources = [...new Set(fullData.map(d => d.sumber))];

            categoryFilter.innerHTML = '<option value="all">Semua Kategori</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });

            sourceFilter.innerHTML = '<option value="all">Semua Sumber</option>';
            sources.forEach(src => {
                const option = document.createElement('option');
                option.value = src;
                option.textContent = src;
                sourceFilter.appendChild(option);
            });
        };

        const renderTable = (data) => {
            budgetTableBody.innerHTML = '';
            if (data.length === 0) {
                budgetTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4">Data tidak ditemukan.</td></tr>`;
            }
            data.forEach((d) => {
                // For contingency item, it doesn't have an ID from budgetData, so it's not editable.
                const isContingency = (d.item === 'Biaya Tak Terduga (Kontingensi)');

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3 text-gray-800 border-b border-gray-200">${d.item}</td>
                    <td class="p-3 text-gray-600 border-b border-gray-200">${d.kategori}</td>
                    <td class="p-3 text-gray-800 border-b border-gray-200 text-right font-medium">${formatCurrency(d.total)}</td>
                    <td class="p-3 text-gray-600 border-b border-gray-200">${d.sumber}</td>
                    <td class="p-3 text-gray-600 border-b border-gray-200">${d.penanggungJawab || '-'}</td>
                    <td class="p-3 text-center border-b border-gray-200">
                        ${(currentUser && currentUser.role === 'admin' && !isContingency) ? `<button data-id="${d.id}" class="edit-btn text-blue-600 hover:text-blue-800 font-semibold mr-2">Edit</button>` : ''}
                        ${(currentUser && currentUser.role === 'admin' && !isContingency) ? `<button data-id="${d.id}" class="delete-btn text-red-600 hover:text-red-800 font-semibold">Hapus</button>` : ''}
                        ${(currentUser && currentUser.role !== 'admin' && !isContingency) ? `<span class="text-gray-500 text-xs">Hanya Admin</span>` : ''}
                    </td>
                `;
                budgetTableBody.appendChild(row);
            });
            tableSummary.textContent = `Menampilkan ${data.length} dari ${getFullBudgetData().length} total item anggaran.`;
        };

        const filterData = () => {
            let filteredData = [...getFullBudgetData()];
            const category = categoryFilter.value;
            const source = sourceFilter.value;
            const searchTerm = searchBox.value.toLowerCase();

            if (category !== 'all') {
                filteredData = filteredData.filter(d => d.kategori === category);
            }
            if (source !== 'all') {
                filteredData = filteredData.filter(d => d.sumber === source);
            }
            if (searchTerm) {
                filteredData = filteredData.filter(d => 
                    d.item.toLowerCase().includes(searchTerm) || 
                    d.kategori.toLowerCase().includes(searchTerm) ||
                    (d.penanggungJawab && d.penanggungJawab.toLowerCase().includes(searchTerm))
                );
            }
            renderTable(filteredData);
        };

        const setupKPIs = () => {
            const fullData = getFullBudgetData();
            const totalAnggaran = fullData.reduce((sum, item) => sum + item.total, 0);
            const danaMasyarakat = fullData.filter(d => d.sumber === 'Masyarakat').reduce((sum, item) => sum + item.total, 0);
            const danaDonatur = fullData.filter(d => d.sumber === 'Donatur Musiman').reduce((sum, item) => sum + item.total, 0);
            
            document.getElementById('totalAnggaran').textContent = formatCurrency(totalAnggaran);
            document.getElementById('danaMasyarakat').textContent = formatCurrency(danaMasyarakat);
            document.getElementById('danaDonatur').textContent = formatCurrency(danaDonatur);
        };
        
        const setupCategoryChart = () => {
            const fullData = getFullBudgetData();
            const categories = [...new Set(fullData.map(item => item.kategori))];
            const data = categories.map(cat => {
                return fullData.filter(item => item.kategori === cat).reduce((sum, item) => sum + item.total, 0);
            });

            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }

            const ctx = document.getElementById('categoryChart').getContext('2d');
            categoryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#b91c1c', '#1d4ed8', '#047857', '#f59e0b', '#7c3aed', '#ef4444', '#3b82f6', '#10b981', '#fcd34d', '#a855f7'],
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15,
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        };

        const setupSourceChart = () => {
            const fullData = getFullBudgetData();
            const sources = [...new Set(fullData.map(item => item.sumber))];
            const data = sources.map(src => {
                return fullData.filter(item => item.sumber === src).reduce((sum, item) => sum + item.total, 0);
            });
            
            if (sourceChartInstance) {
                sourceChartInstance.destroy();
            }

            const ctx = document.getElementById('sourceChart').getContext('2d');
            sourceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sources.map(s => s.replace('/', '/\n')),
                    datasets: [{
                        label: 'Total Dana',
                        data: data,
                        backgroundColor: ['#1d4ed8', '#047857', '#6b7280', '#b91c1c'],
                        borderRadius: 6,
                        borderWidth: 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            ticks: {
                                callback: function(value, index, ticks) {
                                    return 'Rp ' + (value / 1000000) + ' Jt';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        }
                    }
                }
            });
        };

        const setupAccordion = () => {
            const container = document.getElementById('accordionContainer');
            container.innerHTML = ''; 
            notesData.forEach((note, index) => {
                const item = document.createElement('div');
                item.className = 'bg-white border border-gray-200 rounded-lg mb-2 shadow-sm';
                item.innerHTML = `
                    <button class="accordion-toggle w-full flex justify-between items-center p-4 text-left font-semibold text-gray-800 hover:bg-gray-50">
                        <span>${note.title}</span>
                        <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content">
                        <p class="p-4 pt-0 text-gray-600">${note.content}</p>
                    </div>
                `;
                container.appendChild(item);
            });

            container.addEventListener('click', function(e) {
                const toggle = e.target.closest('.accordion-toggle');
                if(toggle) {
                    const content = toggle.nextElementSibling;
                    const icon = toggle.querySelector('svg');
                    
                    if(content.style.maxHeight) {
                        content.style.maxHeight = null;
                        icon.classList.remove('rotate-180');
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                        icon.classList.add('rotate-180');
                    }
                }
            });
        };

        const updateAllVisualizations = () => {
            populateFilters();
            filterData();
            setupKPIs();
            setupCategoryChart();
            setupSourceChart();
        };

        const clearForm = () => {
            formKategori.value = '';
            formItem.value = '';
            formVolume.value = '';
            formSatuan.value = '';
            formHarga.value = '';
            formSumber.value = '';
            formPenanggungJawab.value = '';
            addItemBtn.classList.remove('hidden');
            updateItemBtn.classList.add('hidden');
            cancelEditBtn.classList.add('hidden');
            currentEditId = null; // Reset to null
        };

        const populateFormForEdit = (itemId) => { // Now takes an ID
            const itemToEdit = budgetData.find(item => item.id === itemId);
            if (!itemToEdit) return; // Should not happen if ID is valid

            formKategori.value = itemToEdit.kategori;
            formItem.value = itemToEdit.item;
            formVolume.value = itemToEdit.volume;
            formSatuan.value = itemToEdit.satuan;
            formHarga.value = itemToEdit.harga;
            formSumber.value = itemToEdit.sumber;
            formPenanggungJawab.value = itemToEdit.penanggungJawab || '';

            addItemBtn.classList.add('hidden');
            updateItemBtn.classList.remove('hidden');
            cancelEditBtn.classList.remove('hidden');
            currentEditId = itemId; // Store the ID
        };

        // --- User Management Functions (Admin Panel - Local Storage Mock) ---

        const loadUsersData = () => {
            const storedUsers = localStorage.getItem('users');
            if (storedUsers) {
                users = JSON.parse(storedUsers);
                users.forEach(user => { // Ensure all loaded users have an ID
                    if (!user.id) {
                        user.id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                });
            } else {
                // Default admin user if no users exist, ensure ID is present
                users = [{ id: 'admin123', username: ADMIN_USERNAME, role: 'admin' }];
            }
            renderUsersTable(users);
        };

        const saveUsersData = () => {
            localStorage.setItem('users', JSON.stringify(users));
            console.log('User data auto-saved to local storage.');
        };

        const fetchUsers = () => {
            if (!currentUser || currentUser.role !== 'admin') {
                userManagementMessage.textContent = 'Akses ditolak. Hanya admin yang dapat melihat pengguna.';
                return;
            }
            // In a real app, this would be an API call. Here, we just use the local 'users' array.
            renderUsersTable(users);
            userManagementMessage.textContent = '';
        };

        const renderUsersTable = (usersToRender) => {
            usersTableBody.innerHTML = '';
            if (usersToRender.length === 0) {
                usersTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-4">Belum ada pengguna terdaftar.</td></tr>`;
                return;
            }
            usersToRender.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3 text-gray-800 border-b border-gray-200">${user.username}</td>
                    <td class="p-3 text-gray-600 border-b border-gray-200">${user.role}</td>
                    <td class="p-3 text-center border-b border-gray-200">
                        ${user.username !== currentUser.username ? `<button data-id="${user.id}" class="delete-user-btn text-red-600 hover:text-red-800 font-semibold">Hapus</button>` : ''}
                    </td>
                `;
                usersTableBody.appendChild(row);
            });
        };

        const addUser = (username, password, role) => {
            if (!currentUser || currentUser.role !== 'admin') {
                showModal('Akses ditolak. Hanya admin yang dapat menambah pengguna.', 'alert');
                return;
            }
            if (users.some(u => u.username === username)) {
                userManagementMessage.textContent = `Username '${username}' sudah ada.`;
                return;
            }

            const newUser = {
                id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9), // Generate new ID
                username: username,
                password: password, // In real app, this would be hashed!
                role: role
            };
            users.push(newUser);
            saveUsersData(); // Save to local storage
            userManagementMessage.textContent = `Pengguna '${username}' berhasil ditambahkan.`;
            addUserForm.reset();
            fetchUsers(); // Refresh the list
        };

        const deleteUser = (userId) => {
            if (!currentUser || currentUser.role !== 'admin') {
                showModal('Akses ditolak. Hanya admin yang dapat menghapus pengguna.', 'alert');
                return;
            }
            showModal('Apakah Anda yakin ingin menghapus pengguna ini?', 'confirm', (confirmed) => {
                if (confirmed) {
                    const initialLength = users.length;
                    users = users.filter(u => u.id !== userId);
                    if (users.length < initialLength) {
                        saveUsersData(); // Save to local storage
                        userManagementMessage.textContent = 'Pengguna berhasil dihapus.';
                        fetchUsers(); // Refresh the list
                    } else {
                        userManagementMessage.textContent = 'Gagal menghapus pengguna.';
                    }
                }
            });
        };

        // --- Event Listeners ---

        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;
            login(username, password);
        });

        logoutButton.addEventListener('click', logout);

        navDashboard.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(kpiSection);
            visualizationsSection.classList.remove('hidden'); // Ensure visualizations are also shown
            updateAllVisualizations(); // Refresh data on dashboard view
        });

        navManageBudget.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(manageBudgetSection);
            // Ensure only admin can add/edit
            if (currentUser && currentUser.role === 'admin') {
                budgetForm.classList.remove('hidden');
            } else {
                budgetForm.classList.add('hidden');
                showModal('Anda tidak memiliki izin untuk mengelola anggaran. Hanya admin yang dapat.', 'alert');
            }
            clearForm(); // Clear form on navigation
        });

        navUserDetails.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(detailsSection);
            filterData(); // Ensure table is rendered
        });

        navAdminPanel.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUser && currentUser.role === 'admin') {
                showSection(adminPanelSection);
                fetchUsers(); // Load users for admin
            } else {
                showModal('Akses ditolak. Anda bukan admin.', 'alert');
            }
        });

        budgetForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (!currentUser || currentUser.role !== 'admin') {
                showModal('Hanya admin yang dapat menambah atau memperbarui item anggaran.', 'alert');
                return;
            }

            const newItem = {
                // Generate a new ID only if adding a new item
                id: currentEditId || 'item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                kategori: formKategori.value,
                item: formItem.value,
                volume: parseInt(formVolume.value),
                satuan: formSatuan.value,
                harga: parseInt(formHarga.value),
                total: parseInt(formVolume.value) * parseInt(formHarga.value),
                sumber: formSumber.value,
                penanggungJawab: formPenanggungJawab.value
            };

            if (currentEditId === null) { // If currentEditId is null, it's a new item
                budgetData.push(newItem);
            } else { // Otherwise, it's an update
                const indexToUpdate = budgetData.findIndex(item => item.id === currentEditId);
                if (indexToUpdate !== -1) {
                    budgetData[indexToUpdate] = newItem; // Replace the item with the updated one
                }
            }
            clearForm();
            updateAllVisualizations();
            saveBudgetData(); // Explicitly save after adding/editing
        });

        cancelEditBtn.addEventListener('click', clearForm);

        budgetTableBody.addEventListener('click', function(e) {
            // Check if the clicked element or its parent is a button
            const targetButton = e.target.closest('button');
            if (!targetButton) return; // Not a button, do nothing

            if (!currentUser || currentUser.role !== 'admin') {
                showModal('Hanya admin yang dapat mengedit atau menghapus item anggaran.', 'alert');
                return;
            }

            if (targetButton.classList.contains('edit-btn')) {
                const itemId = targetButton.dataset.id; // Get ID from data-id attribute
                populateFormForEdit(itemId);
            } else if (targetButton.classList.contains('delete-btn')) {
                const itemId = targetButton.dataset.id; // Get ID from data-id attribute
                showModal('Apakah Anda yakin ingin menghapus item ini?', 'confirm', (confirmed) => {
                    if (confirmed) {
                        // Find index by ID to delete
                        const indexToDelete = budgetData.findIndex(item => item.id === itemId);
                        if (indexToDelete !== -1) {
                            budgetData.splice(indexToDelete, 1);
                            updateAllVisualizations();
                            saveBudgetData(); // Explicitly save after deleting
                        }
                    }
                });
            }
        });

        addUserForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const newUsername = newUsernameInput.value;
            const newPassword = newPasswordInput.value;
            const newUserRole = newUserRoleSelect.value;
            addUser(newUsername, newPassword, newUserRole);
        });

        usersTableBody.addEventListener('click', function(e) {
            const targetButton = e.target.closest('button');
            if (!targetButton) return;

            if (targetButton.classList.contains('delete-user-btn')) {
                const userId = targetButton.dataset.id;
                deleteUser(userId);
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth(); // Initial check for login state
            setupAccordion(); // Accordion doesn't depend on budget data
            categoryFilter.addEventListener('change', filterData);
            sourceFilter.addEventListener('change', filterData);
            searchBox.addEventListener('keyup', filterData);
        });
    </script>
</body>
</html>
